
\chapter{Contract BftgRoot}

\minitoc

\section{Overview}


In file {\tt BftgRoot.sol}

\section{Contract Inheritance}


\noindent\begin{tabular}{|l|p{5cm}|}\hline
Base & \\\hline
IBftgRoot & \\\hline
IBftgRootStoreCallback & \\\hline
ContestResolver & \\\hline
JuryGroupResolver & \\\hline
Checks & \\\hline
\end{tabular}


\section{Constant Definitions}


\begin{lstlisting}[firstnumber=18]
    uint8 constant CHECK_CONTEST_CODE = 1;
\end{lstlisting}

\begin{lstlisting}[firstnumber=19]
    uint8 constant CHECK_JURY_GROUP_CODE = 2;
\end{lstlisting}

\section{Variable Definitions}


\ifsoltables
\noindent\begin{tabular}{|l|l|p{5cm}|}\hline
address & \_{}addrBftgRootStore &  \\\hline
 & & used in @1.BftgRoot.deployContest\\\hline
 & & assigned in @1.BftgRoot.:constructor\\\hline
 & & used in @1.BftgRoot.:constructor\\\hline
bool & \_{}inited & Initialized to false \\\hline
 & & assigned in @1.BftgRoot.\_{}onInit\\\hline
 & & used in @1.BftgRoot.\_{}onInit\\\hline
 & & used in @1.BftgRoot.\_{}onInit\\\hline
mapping (address =$>$ JuryGroupPending) & \_{}juryGroupPendings &  \\\hline
 & & assigned in @1.BftgRoot.registerMemberJuryGroup\\\hline
 & & used in @1.BftgRoot.registerMemberJuryGroup\\\hline
 & & assigned in @1.BftgRoot.getMembersCallback\\\hline
 & & used in @1.BftgRoot.getMembersCallback\\\hline
 & & used in @1.BftgRoot.getMembersCallback\\\hline
 & & used in @1.BftgRoot.getMembersCallback\\\hline
 & & assigned in @1.BftgRoot.:onBounce\\\hline
 & & used in @1.BftgRoot.:onBounce\\\hline
 & & used in @1.BftgRoot.:onBounce\\\hline
 & & used in @1.BftgRoot.:onBounce\\\hline
 & & used in @1.BftgRoot.:onBounce\\\hline
 & & used in @1.BftgRoot.:onBounce\\\hline
\end{tabular}
\fi


\begin{lstlisting}[firstnumber=34]
    address _addrBftgRootStore;
\end{lstlisting}

\begin{lstlisting}[firstnumber=54]
    bool public _inited = false;
\end{lstlisting}

\begin{lstlisting}[firstnumber=110]
    mapping(address => JuryGroupPending) _juryGroupPendings;
\end{lstlisting}

\section{Modifier Definitions}


\subsection{Modifier onlyStore}


\begin{lstlisting}[firstnumber=29]
    modifier onlyStore() {
        require(msg.sender == _addrBftgRootStore, Errors.ONLY_STORE);
        _;
    }
\end{lstlisting}

\section{Constructor Definitions}


\subsection{Constructor}

\issueCritical{Constructor for BftgRoot (fake)}{loren ipsum  loren ipsum  loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum

loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum
loren ipsum loren ipsum loren ipsum }
\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=36]
    constructor(address addrBftgRootStore) public {
        if (msg.sender == address(0)) {
            require(msg.pubkey() == tvm.pubkey(), Errors.ONLY_SIGNED);
        }
        require(addrBftgRootStore != address(0), Errors.STORE_UNDEFINED);
        tvm.accept();

        _addrBftgRootStore = addrBftgRootStore;
        IBftgRootStore(addrBftgRootStore).queryCode
            {value: 0.2 ton, bounce: true}
            (ContractCode.Contest);
        IBftgRootStore(addrBftgRootStore).queryCode
            {value: 0.2 ton, bounce: true}
            (ContractCode.JuryGroup);

        _createChecks();
    }
\end{lstlisting}

\section{Public Method Definitions}


\subsection{OnBounce function}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=83]
    onBounce(TvmSlice) external {
        if(_juryGroupPendings.exists(msg.sender)) {
            address[] _;
            deployJuryGroup(_juryGroupPendings[msg.sender].tag, _);
            this.registerMemberJuryGroup
                {value: 0, bounce: false, flag: 64}
                (_juryGroupPendings[msg.sender].tag, _juryGroupPendings[msg.sender].addrJury);
            delete _juryGroupPendings[msg.sender];
        }
    }
\end{lstlisting}

\subsection{Function deployContest}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=98]
    function deployContest(string[] tags, uint128 prizePool, uint32 underwayDuration) external view {
        tvm.accept();
        TvmCell state = _buildContestState(address(this));
        new Contest
            {stateInit: state, value: 1 ton}
            (_addrBftgRootStore, tags, prizePool, underwayDuration);
    }
\end{lstlisting}

\subsection{Function deployJuryGroup}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=112]
    function deployJuryGroup(string tag, address[] initialMembers) public view {
        require(address(0) != msg.sender);
        TvmCell state = _buildJuryGroupState(tag, address(this));
        new JuryGroup
            {stateInit: state, value: 0.3 ton}
            (initialMembers);
    }
\end{lstlisting}

\subsection{Function getMembersCallback}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=130]
    function getMembersCallback(mapping(address => Member) members) public {
        require(_juryGroupPendings.exists(msg.sender) || address(this) == msg.sender, 106);
        IJuryGroup(msg.sender).registerMember
            {value: 0 ton, bounce: true, flag: 64}
            (_juryGroupPendings[msg.sender].addrJury);
        delete _juryGroupPendings[msg.sender];
    }
\end{lstlisting}

\subsection{Function getStored}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=142]
    function getStored() public view returns (
        TvmCell codeContest,
        TvmCell codeJuryGroup
    ) {
        codeContest = _codeContest;
        codeJuryGroup = _codeJuryGroup;
    }
\end{lstlisting}

\subsection{Function registerMemberJuryGroup}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=120]
    function registerMemberJuryGroup(string tag, address addrMember) public override {
        address addrContest = resolveContest(address(this));
        address addrJuryGroup = resolveJuryGroup(tag, address(this));
        require(msg.sender == addrContest || address(this) == msg.sender, 105);
        _juryGroupPendings[addrJuryGroup] = JuryGroupPending(addrMember, tag);
        IJuryGroup(addrJuryGroup).getMembers
            {value: 0, bounce: true, flag: 64}
            ();
    }
\end{lstlisting}

\subsection{Function updateAddr}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=77]
    function updateAddr(ContractAddr kind, address addr) external override {}
\end{lstlisting}

\subsection{Function updateCode}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=62]
    function updateCode(
        ContractCode kind,
        TvmCell code
    ) external override onlyStore {
        if (kind == ContractCode.Contest) {
            _codeContest = code;
            _passCheck(CHECK_CONTEST_CODE);
        }
        if (kind == ContractCode.JuryGroup) {
            _codeJuryGroup = code;
            _passCheck(CHECK_JURY_GROUP_CODE);
        }
        _onInit();
    }
\end{lstlisting}

\section{Internal Method Definitions}


\subsection{Function \_{}createChecks}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=21]
    function _createChecks() private inline {
        _checkList = CHECK_CONTEST_CODE | CHECK_JURY_GROUP_CODE;
    }
\end{lstlisting}

\subsection{Function \_{}onInit}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=56]
    function _onInit() private {
        if(_isCheckListEmpty() && !_inited) {
            _inited = true;
        }
    }
\end{lstlisting}
