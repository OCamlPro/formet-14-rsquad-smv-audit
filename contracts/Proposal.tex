
\chapter{Contract Proposal}

\minitoc

In file {\tt Proposal.sol}

\section{Contract Inheritance}


\noindent\begin{tabular}{|l|p{5cm}|}\hline
Base & \\\hline
PadawanResolver & \\\hline
IProposal & \\\hline
\end{tabular}


\section{Event Definitions}


\begin{lstlisting}[firstnumber=23]
    event ProposalFinalized(ProposalResults results);
\end{lstlisting}

\section{Static Variable Definitions}


\ifsoltables
\noindent\begin{tabular}{|l|l|p{5cm}|}\hline
address & \_{}deployer &  \\\hline
 & & used in @3.Proposal.\_{}buildPadawanState\\\hline
 & & used in @3.Proposal.:constructor\\\hline
string & \_{}title &  \\\hline
 & & used in @3.Proposal.:constructor\\\hline
\end{tabular}
\fi


\begin{lstlisting}[firstnumber=13]
    address static _deployer;
\end{lstlisting}

\begin{lstlisting}[firstnumber=14]
    string static _title;
\end{lstlisting}

\section{Variable Definitions}


\ifsoltables
\noindent\begin{tabular}{|l|l|p{5cm}|}\hline
address & \_{}addrClient &  \\\hline
 & & used in @3.Proposal.\_{}finalize\\\hline
 & & assigned in @3.Proposal.:constructor\\\hline
 & & used in @3.Proposal.:constructor\\\hline
ProposalInfo & \_{}proposalInfo &  \\\hline
 & & assigned in @3.Proposal.vote\\\hline
 & & used in @3.Proposal.vote\\\hline
 & & assigned in @3.Proposal.vote\\\hline
 & & used in @3.Proposal.vote\\\hline
 & & used in @3.Proposal.vote\\\hline
 & & used in @3.Proposal.vote\\\hline
 & & used in @3.Proposal.queryStatus\\\hline
 & & used in @3.Proposal.getVotingResults\\\hline
 & & used in @3.Proposal.getInfo\\\hline
 & & used in @3.Proposal.getCurrentVotes\\\hline
 & & used in @3.Proposal.getCurrentVotes\\\hline
 & & used in @3.Proposal.getAll\\\hline
 & & used in @3.Proposal.\_{}wrapUp\\\hline
 & & used in @3.Proposal.\_{}wrapUp\\\hline
 & & used in @3.Proposal.\_{}wrapUp\\\hline
 & & used in @3.Proposal.\_{}wrapUp\\\hline
 & & used in @3.Proposal.\_{}wrapUp\\\hline
 & & used in @3.Proposal.\_{}tryEarlyComplete\\\hline
 & & used in @3.Proposal.\_{}tryEarlyComplete\\\hline
 & & used in @3.Proposal.\_{}softMajority\\\hline
 & & used in @3.Proposal.\_{}softMajority\\\hline
 & & used in @3.Proposal.\_{}softMajority\\\hline
 & & used in @3.Proposal.\_{}softMajority\\\hline
 & & used in @3.Proposal.\_{}finalize\\\hline
 & & used in @3.Proposal.\_{}finalize\\\hline
 & & used in @3.Proposal.\_{}finalize\\\hline
 & & used in @3.Proposal.\_{}finalize\\\hline
 & & assigned in @3.Proposal.\_{}changeState\\\hline
 & & used in @3.Proposal.\_{}changeState\\\hline
 & & assigned in @3.Proposal.:constructor\\\hline
 & & used in @3.Proposal.:constructor\\\hline
 & & assigned in @3.Proposal.:constructor\\\hline
 & & used in @3.Proposal.:constructor\\\hline
 & & assigned in @3.Proposal.:constructor\\\hline
 & & used in @3.Proposal.:constructor\\\hline
 & & assigned in @3.Proposal.:constructor\\\hline
 & & used in @3.Proposal.:constructor\\\hline
 & & assigned in @3.Proposal.:constructor\\\hline
 & & used in @3.Proposal.:constructor\\\hline
 & & assigned in @3.Proposal.:constructor\\\hline
 & & used in @3.Proposal.:constructor\\\hline
 & & assigned in @3.Proposal.:constructor\\\hline
 & & used in @3.Proposal.:constructor\\\hline
ProposalResults & \_{}results &  \\\hline
 & & used in @3.Proposal.getVotingResults\\\hline
 & & used in @3.Proposal.\_{}finalize\\\hline
 & & assigned in @3.Proposal.\_{}finalize\\\hline
 & & used in @3.Proposal.\_{}finalize\\\hline
VoteCountModel & \_{}voteCountModel &  \\\hline
 & & used in @3.Proposal.\_{}finalize\\\hline
 & & assigned in @3.Proposal.:constructor\\\hline
 & & used in @3.Proposal.:constructor\\\hline
\end{tabular}
\fi


\begin{lstlisting}[firstnumber=16]
    address public _addrClient;
\end{lstlisting}

\begin{lstlisting}[firstnumber=18]
    ProposalInfo public _proposalInfo;
\end{lstlisting}

\begin{lstlisting}[firstnumber=20]
    ProposalResults _results;
\end{lstlisting}

\begin{lstlisting}[firstnumber=21]
    VoteCountModel _voteCountModel;
\end{lstlisting}

\section{Constructor Definitions}


\subsection{Constructor}

\issueCritical{Constructor for Proposal (fake)}{loren ipsum  loren ipsum  loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum

loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum loren ipsum
loren ipsum loren ipsum loren ipsum }
\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=25]
    constructor(
        uint128 totalVotes,
        address addrClient,
        ProposalType proposalType,
        TvmCell specific,
        TvmCell codePadawan
    ) public {
        require(_deployer == msg.sender);

        _addrClient = addrClient;

        _proposalInfo.title = _title;
        _proposalInfo.start = uint32(now);
        _proposalInfo.end = uint32(now + 60 * 60 * 24 * 7);
        _proposalInfo.proposalType = proposalType;
        _proposalInfo.specific = specific;
        _proposalInfo.state = ProposalState.New;
        _proposalInfo.totalVotes = totalVotes;

        _codePadawan = codePadawan;

        _voteCountModel = VoteCountModel.SoftMajority;
    }
\end{lstlisting}

\section{Public Method Definitions}


\subsection{Function getAll}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=168]
    function getAll() public view override returns (ProposalInfo info) {
        info = _proposalInfo;
    }
\end{lstlisting}

\subsection{Function getCurrentVotes}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=181]
    function getCurrentVotes() external override view returns (uint32 votesFor, uint32 votesAgainst) {
        return (_proposalInfo.votesFor, _proposalInfo.votesAgainst);
    }
\end{lstlisting}

\subsection{Function getInfo}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=177]
    function getInfo() public view returns (ProposalInfo info) {
        info = _proposalInfo;
    }
\end{lstlisting}

\subsection{Function getVotingResults}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=172]
    function getVotingResults() public view returns (ProposalResults vr) {
        require(_proposalInfo.state > ProposalState.Ended, Errors.VOTING_HAS_NOT_ENDED);
        vr = _results;
    }
\end{lstlisting}

\subsection{Function queryStatus}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=162]
    function queryStatus() external override {
        IPadawan(msg.sender).updateStatus(_proposalInfo.state);
    }
\end{lstlisting}

\subsection{Function vote}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=55]
    function vote(address addrPadawanOwner, bool choice, uint32 votesCount) external override {
        address addrPadawan = resolvePadawan(addrPadawanOwner);
        uint16 errorCode = 0;

        if (addrPadawan != msg.sender) {
            errorCode = Errors.NOT_AUTHORIZED_CONTRACT;
        } else if (now < _proposalInfo.start) {
            errorCode = Errors.VOTING_NOT_STARTED;
        } else if (now > _proposalInfo.end) {
            errorCode = Errors.VOTING_HAS_ENDED;
        }

        if (errorCode > 0) {
            IPadawan(msg.sender).rejectVote{value: 0, flag: 64, bounce: true}(votesCount, errorCode);
        } else {
            IPadawan(msg.sender).confirmVote{value: 0, flag: 64, bounce: true}(votesCount);
            if (choice) {
                _proposalInfo.votesFor += votesCount;
            } else {
                _proposalInfo.votesAgainst += votesCount;
            }
        }

        _wrapUp();
    }
\end{lstlisting}

\subsection{Function wrapUp}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=49]
    function wrapUp() external override {
        _wrapUp();
        msg.sender.transfer(0, false, 64);
    }
\end{lstlisting}

\section{Internal Method Definitions}


\subsection{Function \_{}buildPadawanState}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=154]
    function _buildPadawanState(address owner) internal view override returns (TvmCell) {
        return tvm.buildStateInit({
            contr: Padawan,
            varInit: {_deployer: _deployer, _owner: owner},
            code: _codePadawan
        });
    }
\end{lstlisting}

\subsection{Function \_{}calculateVotes}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=132]
    function _calculateVotes(
        uint32 yes,
        uint32 no
    ) private view returns (bool) {
        bool passed = false;
        passed = _softMajority(yes, no);
        return passed;
    }
\end{lstlisting}

\subsection{Function \_{}changeState}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=150]
    function _changeState(ProposalState state) private inline {
        _proposalInfo.state = state;
    }
\end{lstlisting}

\subsection{Function \_{}finalize}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=81]
    function _finalize(bool passed) private {
        _results = ProposalResults(
            uint32(0),
            passed,
            _proposalInfo.votesFor,
            _proposalInfo.votesAgainst,
            _proposalInfo.totalVotes,
            _voteCountModel,
            uint32(now)
        );

        ProposalState state = passed ? ProposalState.Passed : ProposalState.NotPassed;

        _changeState(state);

        IClient(address(_addrClient)).onProposalPassed{value: 1 ton} (_proposalInfo);

        emit ProposalFinalized(_results);
    }
\end{lstlisting}

\subsection{Function \_{}softMajority}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=141]
    function _softMajority(
        uint32 yes,
        uint32 no
    ) private view returns (bool) {
        bool passed = false;
        passed = yes >= 1 + (_proposalInfo.totalVotes / 10) + (no * ((_proposalInfo.totalVotes / 2) - (_proposalInfo.totalVotes / 10))) / (_proposalInfo.totalVotes / 2);
        return passed;
    }
\end{lstlisting}

\subsection{Function \_{}tryEarlyComplete}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=101]
    function _tryEarlyComplete(
        uint32 yes,
        uint32 no
    ) private view returns (bool, bool) {
        (bool completed, bool passed) = (false, false);
        if (yes * 2 > _proposalInfo.totalVotes) {
            completed = true;
            passed = true;
        } else if(no * 2 >= _proposalInfo.totalVotes) {
            completed = true;
            passed = false;
        }
        return (completed, passed);
    }
\end{lstlisting}

\subsection{Function \_{}wrapUp}

\begin{itemize}
\item TODO
\end{itemize}

\begin{lstlisting}[firstnumber=116]
    function _wrapUp() private {
        (bool completed, bool passed) = (false, false);

        if (now > _proposalInfo.end) {
            completed = true;
            passed = _calculateVotes(_proposalInfo.votesFor, _proposalInfo.votesAgainst);
        } else {
            (completed, passed) = _tryEarlyComplete(_proposalInfo.votesFor, _proposalInfo.votesAgainst);
        }

        if (completed) {
            _changeState(ProposalState.Ended);
            _finalize(passed);
        }
    }
\end{lstlisting}
